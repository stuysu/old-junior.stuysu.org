class AuthMode{static clean(e){return void 0===e?e:e.trim().toLowerCase()}static Mode="production"!==AuthMode.clean(process.env.NODE_ENV)?AuthMode.clean(process.env.AUTHENTICATION_MODE):"full";static shouldAuth(){return void 0===AuthMode.Mode||"full"===AuthMode.Mode}static shouldAsk(){return"show"===AuthMode.Mode||AuthMode.shouldAuth()}static shouldSkip(){return!AuthMode.shouldAsk()}}module.exports.AuthMode=AuthMode;const CLIENT_ID=process.env.CLIENT_ID,CLIENT_SECRET=process.env.CLIENT_SECRET,{OAuth2Client:OAuth2Client}=require("google-auth-library"),{Subs:Subs}=require("../models"),client=new OAuth2Client(CLIENT_ID,CLIENT_SECRET);async function verifySignInToken(e){const o=(await client.verifyIdToken({idToken:e,CLIENT_ID:CLIENT_ID})).getPayload();if(AuthMode.shouldAuth()){if(null===await Subs.findOne({where:{sub:o.sub}}))throw new Error(`${o.sub} of email ${o.email} is not whitelisted`)}return{ok:!0,payload:o}}async function isDoubleCookieValid(e){let o=e.cookies.g_csrf_token;if(void 0===o)throw new Error("No CSRF token in Cookie");let t=e.body.g_csrf_token;if(void 0===t)throw new Error("No CSRF token in body");if(t!=o)throw new Error("Failed to verify double CSRF tokens");return!0}module.exports.verifySignInToken=verifySignInToken,module.exports.isDoubleCookieValid=isDoubleCookieValid;const jwt=require("jsonwebtoken"),SECRET=process.env.ACCESS_TOKEN_SECRET,ACCESS_TOKEN_OPTIONS={expiresIn:"15m"},{Cookie:Cookie}=require("./cookie"),TOKEN_COOKIE=new Cookie("jid",{httpOnly:!0,sameSite:!0,secure:"development"!==process.env.NODE_ENV,path:"/",maxAge:6048e5});function getAccessTokenPayload(e){return{sub:e.sub,name:e.name,picture:e.picture,email:e.email}}function getAccessToken(e){return jwt.sign(getAccessTokenPayload(e),SECRET,ACCESS_TOKEN_OPTIONS)}function verifyAccessToken(e){return jwt.verify(e,SECRET)}function verifyRequest(e,o){const t=TOKEN_COOKIE.get(e);try{return{ok:!0,payload:verifyAccessToken(t),error:void 0}}catch(e){if(e instanceof jwt.TokenExpiredError){console.log("Token expired, regenerating");let e=jwt.decode(t);delete e.iat,delete e.exp;const n=getAccessToken(e);return TOKEN_COOKIE.set(o,n),e=jwt.decode(n),{ok:!0,payload:e}}return console.error(e),{ok:!1,payload:void 0,error:e}}}function authed(e){return async function(o,t,n){if(AuthMode.shouldSkip())return t.locals.payload=getAccessTokenPayload({sub:0,email:"john@doe.com",name:"John Doe",picture:"https://i.stack.imgur.com/34AD2.jpg"}),e.allowSkip?n():t.redirect("/admin");let{ok:r,payload:i,error:u}=verifyRequest(o,t);r?(t.locals={...t.locals,...i},e.authorized(o,t,n)):e.unauthorized(u,o,t,n)}}module.exports.getAccessToken=getAccessToken,module.exports.TokenCookie=TOKEN_COOKIE;const SIGN_IN_COOKIE=new Cookie("signinfail",{path:"/admin/signin",httpOnly:!0,sameSite:!0});function toSignIn(e,o){void 0!==o&&"development"!==process.env.NODE_ENV&&(o="Could not authenticate account. Try again later."),o?SIGN_IN_COOKIE.set(e,o):SIGN_IN_COOKIE.clear(e),e.redirect("/admin/signin")}function requireAuthAdmin(){return authed({authorized:(e,o,t)=>t(),unauthorized:(e,o,t,n)=>toSignIn(t,e.message),allowSkip:!0})}function requireUnauthAdmin(){return authed({authorized:(e,o,t)=>o.redirect("/admin"),unauthorized:(e,o,t,n)=>n(),allowSkip:!1})}function requireAuthApi(){return authed({authorized:(e,o,t)=>t(),unauthorized:(e,o,t,n)=>t.status(401).json({error:e.name,message:e.message}),allowSkip:!0})}module.exports.requireAuthAdmin=requireAuthAdmin,module.exports.requireUnauthAdmin=requireUnauthAdmin,module.exports.requireAuthApi=requireAuthApi,module.exports.authed=authed,module.exports.toSignIn=toSignIn,module.exports.SignInCookie=SIGN_IN_COOKIE;
